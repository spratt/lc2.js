<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>lc2.js</title>
    <link rel="stylesheet" type="text/css" 
          href="http://spratt.github.io/EasyCSS/minimalist.css" />
    <style type="text/css">
      body {
        margin: 0 auto;   /* centre horizontally  */
        max-width: 40em;  /* readable line width  */
        line-height: 1.5; /* compact line spacing */
      }
    </style>
  </head>
  <body>
    <h1>lc2.js</h1>
    <h3>By Simon Pratt</h3>
    
    <p>
      A simulator
      of <a href="http://www.cs.utexas.edu/users/fussell/courses/cs310h/simulator/lc2.pdf">the
      LC-2</a> in javascript.  Check out the <a href="tests.html">unit
      tests</a>.
    </p>
    <p>
      <a href="https://github.com/spratt/lc2.js">Source code</a>
      available under <a href="http://opensource.org/licenses/ISC">the
      ISC license</a>.
    </p>
    <p>
      Be warned that this code uses some HTML5 features including
      typed arrays, which may not work in all browsers.
    </p>
    
    <h2>Attributes</h2>
    <dl>
      <dt><code>lc2.debug</code></dt>
      <dd>
        Type: boolean.  Default: false.  If true, log debug
        information to console.
      </dd>
      <dt><code>lc2.conds</code></dt>
      <dd>
        Type: number.  Default: LC2.COND_ZERO (bit 2 set).  Bit 0 is
        set if the previous result was negative.  Bit 1 is set if the
        previous result was positive.  Bit 2 is set if the previous
        result was zero.
      </dd>
      <dt><code>lc2.pc</code></dt>
      <dd>
        Type: Register.  Default: 0.  This is the program counter for
        the LC-2 control unit.  This register stores the memory
        address of the next instruction to be evaluated.
      </dd>
      <dt><code>lc2.ir</code></dt>
      <dd>
        Type: Register.  Default: 0.  This is the instruction register
        for the LC-2 control unit.  Once fetched, this register stores
        the value of the instruction being evaluated.
      </dd>
      <dt><code>lc2.mem</code></dt>
      <dd>
        Type: MemoryUnit.  Controls access to the LC-2 memory.  See
        class description above.
      </dd>
      <dt><code>lc2.r</code></dt>
      <dd>
        Type: array of 8 Registers, each initialized to 0.
      </dd>
    </dl>
    
    <h2>Classes</h2>
    <dl>
      <dt><code>Register</code></dt>
      <dd>
        A 16 bit register.
        
        <p>
          To assign a value to register 0 on an LC2
          instance <code>lc2</code> evaluate: <code>lc2.r[0].val =
          42</code>.
        </p>
        <p>
          To read a value from the same register
          evaluate: <code>lc2.r[0].val</code>.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;
            
            lc2.r[0].val = 42;         // set the value of r0 to 42
            
            console.log(lc2.r[0].val); // 42
          </pre>
        </p>
      </dd>
      <dt><code>MemoryUnit</code></dt>
      <dd>
        Controls access to the LC-2 memory.
        
        <p>
          To retrieve the value at memory location 3000 from the memory
          unit of an LC2 instance <code>lc2</code>, first set the memory
          address register (MAR): <code>lc2.mem.mar = 3000</code>, then
          interrogate the memory unit: <code>lc2.mem.interrogate()</code>,
          then read from the memory data register (MDR):
          <code>lc2.mem.mdr</code>.
        </p>
        
        <p>
          To write a value to memory location 3000 on the same memory
          unit, first set the MAR: <code>lc2.mem.mar = 3000</code>, then
          set the MDR: <code>lc2.mem.mdr = 42</code>, then interrogate
          with the write bit set: <code>lc2.mem.interrogate(1)</code>.
        </p>
        
        <p>
          Example:
          <pre>
            var lc2 = new LC2;
            
            lc2.mem.mar.val = 3000;
            lc2.mem.mdr.val = 8;
            lc2.mem.interrogate(1);       // write 8 to memory location 3000
            
            lc2.mem.mar.val = 3001;
            lc2.mem.mdr.val = 42;
            lc2.mem.interrogate(1);       // write 42 to memory location 3001
            
            lc2.mem.mar.val = 3000;
            lc2.mem.interrogate();
            console.log(lc2.mem.mdr.val); // 8
            
            lc2.mem.mar.val = 3001;
            lc2.mem.interrogate();
            console.log(lc2.mem.mdr.val); // 42
          </pre>
        </p>
      </dd>
    </dl>
    
    <h2>Methods</h2>
    <dl>
      <dt><code>lc2.add(dest_reg,src_reg,imm5_bit,last)</code></dt>
      <dd>
        <p>
          Add the value of the source register <code>src_reg</code> to
          another value and store the result in the destination
          register <code>dest_reg</code>.
        </p>
        <p>
          If the value of <code>imm5_bit</code> is 0,
          interpret <code>last</code> as the number of a register whose
          value is to be added to the source register.
        </p>
        <p>
          If the value of <code>imm5_bit</code> is 1,
          interpret <code>last</code> as a 5-bit immediate value to be added
          to the source register.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;
            
            lc2.add(0,0,1,10);             // r0[0]  = r0[0]  + 10     = 10
            lc2.add(0,0,1,10);             // r0[10] = r0[10] + 10     = 20
            lc2.add(1,1,1,11);             // r1[0]  = r1[0]  + 11     = 11
            lc2.add(1,1,1,11);             // r1[11] = r1[11] + 11     = 22
            lc2.add(2,0,0,1);              // r2[0]  = r0[20] + r1[22] = 42
            
            console.log(lc2.r[2].val);     // 42
          </pre>
        </p>
      </dd>
      <dt><code>lc2.and(dest_reg,src_reg,imm5_bit,last)</code></dt>
      <dd>
        <p>
          Bitwise AND the value of the source register <code>src_reg</code> with
          another value and store the result in the destination
          register <code>dest_reg</code>.
        </p>
        <p>
          If the value of <code>imm5_bit</code> is 0,
          interpret <code>last</code> as the number of a register whose
          value is to be ANDed with the source register.
        </p>
        <p>
          If the value of <code>imm5_bit</code> is 1,
          interpret <code>last</code> as a 5-bit immediate value to be ANDed
          with the source register.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;
            
            lc2.add(0,0,1,5);              // r0[0] = r0[0]  + 5     = 5
            lc2.add(1,1,1,3);              // r3[0] = r3[0]  + 3     = 3
            lc2.and(2,0,0,1);              // r2[0] = r0[5]  & r1[3] = 1
            
            console.log(lc2.r[2].val);     // 1
          </pre>
        </p>
      </dd>
      <dt><code>lc2.not(dest_reg,src_reg)</code></dt>
      <dd>
        <p>
          Bitwise NOT the value of the source
          register <code>src_reg</code> and store the result in the
          destination register <code>dest_reg</code>.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;
            
            lc2.add(0,0,1,5);          // r0[0] = r0[0]  + 5     = 5
            lc2.not(1,0);              // r1[0] = ~r1[5]         = -6
            
            console.log(lc2.r[1].val); // -6
          </pre>
        </p>
      </dd>
      <dt><code>lc2.lea(dest_reg,imm)</code></dt>
      <dd>
        <p>
          Loads the Effective Address (LEA) of bitwise ORing the upper
          7 bits of the value of the pc register with the 9 immediate
          bits of <code>imm</code> and stores the result in the
          destination register <code>dest_reg</code>.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;
            
            lc2.pc.val = parseInt('4018',16);
            lc2.lea(5,parseInt('1fd',16));
            
            console.log(lc2.r[5].val.toString(16)); // 41fd
          </pre>
        </p>
      </dd>
      <dt><code>lc2.ld(dest_reg,dir)</code></dt>
      <dd>
        <p>
          Loads the Direct address (LD) of bitwise ORing the upper 7
          bits of the value of the pc register with the 9 bits bits
          of <code>dir</code>, retrieves the value of the memory at
          that address and stores the result in the destination
          register <code>dest_reg</code>.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;
            
            lc2.mem.mar.val = parseInt('31FD',16);
            lc2.mem.mdr.val = 42;
            lc2.mem.interrogate(1);
            
            lc2.pc.val = parseInt('3000',16);
            lc2.ld(5,parseInt('1fd',16));
            
            console.log(lc2.r[5].val); // 42
          </pre>
        </p>
      </dd>
      <dt><code>lc2.st(src_reg,dir)</code></dt>
      <dd>
        <p>
          STore (ST) the direct address of bitwise ORing the upper 7
          bits of the value of the pc register with the 9 bits bits
          of <code>dir</code>, retrieves the value of the source
          register <code>src_reg</code> and stores the result in the
          memory at the calculated address.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;

            lc2.r[5].val = 42;
            
            lc2.pc.val = parseInt('3000',16);
            lc2.ld(5,parseInt('1fd',16));
            
            lc2.mem.mar.val = parseInt('31FD',16);
            lc2.mem.interrogate();
            
            console.log(lc2.mem.mdr.val); // 42
          </pre>
        </p>
      </dd>
      <dt><code>lc2.ldi(dest_reg,indir)</code></dt>
      <dd>
        <p>
          LoaDs the Indirect address (LDI) of bitwise ORing the upper
          7 bits of the value of the pc register with the 9 bits bits
          of <code>indir</code>, retrieves the value of the memory at
          that address and stores the value of the memory at the
          resulting address in the destination
          register <code>dest_reg</code>.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;
            
            lc2.mem.mar.val = parseInt('4BCC',16);
            lc2.mem.mdr.val = parseInt('2110',16);
            lc2.mem.interrogate(1);
            
            lc2.mem.mar.val = parseInt('2110',16);
            lc2.mem.mdr.val = 42;
            lc2.mem.interrogate(1);
            
            lc2.pc.val = parseInt('4A1B',16);
            lc2.ldi(5,parseInt('1cc',16));
            
            console.log(lc2.r[5].val); // 42
          </pre>
        </p>
      </dd>
      <dt><code>lc2.sti(src_reg,indir)</code></dt>
      <dd>
        <p>
          STore the Indirect address (LDI) of bitwise ORing the upper
          7 bits of the value of the pc register with the 9 bits bits
          of <code>indir</code>, stores the value of the source
          register <code>src_reg</code> at the memory address obtained
          by reading from the memory at the calculated address.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;
            
            lc2.r[3].val = 42;
            lc2.mem.mar.val = parseInt('4BCC',16);
            lc2.mem.mdr.val = parseInt('2110',16);
            lc2.mem.interrogate(1);
            lc2.mem.mdr.val = 0;
            lc2.mem.interrogate();
            
            lc2.pc.val = parseInt('4A1B',16);
            lc2.sti(3,parseInt('1CC',16));
            lc2.mem.mar.val = parseInt('2110',16);
            lc2.mem.interrogate();
            console.log(lc2.mem.mdr.val); // 42
          </pre>
        </p>
      </dd>
      <dt><code>lc2.ldr(dest_reg,base_reg,offset)</code></dt>
      <dd>
        <p>
          LoaDs the base Register (LDR) plus offset.  Add the value of
          the register with number <code>base_reg</code> to the
          literal value of the 6 bits of <code>offset</code>, which
          gives a memory location whose value is loaded
          into <code>dest_reg</code>.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;

            lc2.r[2].val = parseInt('2345',16);
            lc2.mem.mar.val = parseInt('2362',16);
            lc2.mem.mdr.val = 42;
            lc2.mem.interrogate(1);

            lc2.ldr(1,2,parseInt('1D',16));
            console.log(lc2.r[1].val); // 42
          </pre>
        </p>
      </dd>
      <dt><code>lc2.str(src_reg,base_reg,offset)</code></dt>
      <dd>
        <p>
          STores the base Register (LDR) plus offset.  Add the value
          of the register with number <code>base_reg</code> to the
          literal value of the 6 bits of <code>offset</code>, which
          gives a memory location whose value is set to the value
          of <code>src_reg</code>.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;

            lc2.r[1].val = 42;
            lc2.r[2].val = parseInt('2345',16);
            lc2.str(1,2,parseInt('1D',16));
            lc2.mem.mar.val = parseInt('2362',16);
            lc2.mem.interrogate();
            console.log(lc2.mem.mdr.val); // 42
          </pre>
        </p>
      </dd>
      <dt><code>lc2.br(n,z,p,offset)</code></dt>
      <dd>
        <p>
          BRanch (BR) based on the conditional values.  If
          bit <code>n</code> is set, inspect the <code>N</code>
          conditional bit.  If bit <code>z</code> is set, inspect
          the <code>Z</code> conditional bit.  If bit <code>p</code>
          is set, inspect the <code>P</code> conditional bit.  If any
          of the inspected bits are set, set the value of
          the <code>PC</code> register to the result of bitwise ORing
          the upper 7 bits of the instruction address with the 9 bits
          of the <code>offset</code> parameter.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;

            lc2.conds = LC2.COND_POS;
            
            lc2.pc.val = parseInt('3000',16);
            lc2.br(1,1,0,5);
            console.log(lc2.pc.val.toString(16)); // 3001

            lc2.pc.val = parseInt('3000',16);
            lc2.br(0,0,1,100);
            console.log(lc2.pc.val.toString(16)); // 3005
          </pre>
        </p>
      </dd>
      <dt><code>lc2.trap(vector)</code></dt>
      <dd>
        <p>
          Runs operating system code identified
          by <code>vector</code>.  Under the hood, this simply saves
          the value of the <code>PC</code> register to register 7,
          then sets the <code>PC</code> to the value
          of <code>vector</code>.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;
            
            lc2.trap(parseInt('25',16));
            console.log(lc2.pc.val.toString(16)); // 25
          </pre>
        </p>
      </dd>
      <dt><code>lc2.ret()</code></dt>
      <dd>
        <p>
          Returns to regular program execution after a long jump
          like <code>trap</code>.  Under the hood, this sets the value
          of the <code>PC</code> register to the value of register 7.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;
            
            lc2.r[7].val = parseInt('3000',16);
            lc2.ret();
            console.log(lc2.pc.val.toString(16)); // 3000
          </pre>
        </p>
      </dd>
      <dt><code>lc2.run_cycle()</code></dt>
      <dd>
        <p>
          Fetches the memory at address pointed to
          by <code>lc2.pc.val</code> which is loaded
          into <code>lc2.ir.val</code> then <code>lc2.pc.val</code> is
          incremented.  The instruction is then decoded and the
          appropriate method is run on the given operands.
        </p>
        <p>
          Example:
          <pre>
            var lc2 = new LC2;
            
            // load an instruction into memory
            lc2.mem.mar.val = 3000;
            lc2.mem.mdr.val = parseInt('0001001010100101',2); // add(1,2,1,5)
            lc2.mem.interrogate(1);
            
            // point at the right instruction
            lc2.pc.val = 3000;
            lc2.run_cycle();
            
            console.log(lc2.r[1].val); // 5
            console.log(lc2.conds);    // 2     (positive)
            console.log(lc2.pc.val);   // 3001
          </pre>
        </p>
      </dd>
    </dl>
  </body>
  <script src="lc2.js"></script>
</html>
